import{D as f,G as E,Gb as v,a as n,b as o,d as l,f as m,g as d,j as h,n as p,z as g}from"./chunk-MQ32LSW5.js";var b=class S{constructor(e){this.router=e;this.loadUsersFromStorage(),this.initializeSession(),this.startSessionMonitoring()}SESSION_TIMEOUT=30*60*1e3;STORAGE_KEY="auth_session";USERS_KEY="registered_users";users=[{username:"admin",password:"admin123",role:"admin",email:"admin@eventhub.com",fullName:"System Administrator",bio:"System administrator with full access to EventHub platform.",createdAt:new Date("2024-01-01")},{username:"user",password:"user123",role:"user",email:"user@example.com",fullName:"Demo User",bio:"Regular user of EventHub platform.",createdAt:new Date("2024-01-01")}];authStateSubject=new m({isAuthenticated:!1,user:null});authState$=this.authStateSubject.asObservable();currentUser$=this.authState$.pipe(h(e=>e.user));isAuthenticated$=this.authState$.pipe(h(e=>e.isAuthenticated));sessionTimer$=d;sessionEndSubject=new m(!1);loadUsersFromStorage(){let e=localStorage.getItem(this.USERS_KEY);if(e){let t=JSON.parse(e);this.users=[...this.users,...t]}}initializeSession(){let e=localStorage.getItem(this.STORAGE_KEY);if(e)try{let t=JSON.parse(e),s=new Date,r=new Date(t.sessionExpiry);r>s?(this.authStateSubject.next({isAuthenticated:!0,user:t.user,sessionExpiry:r}),this.startSessionTimer(r.getTime()-s.getTime())):this.clearSession()}catch(t){console.error("Error parsing stored session:",t),this.clearSession()}}startSessionMonitoring(){["mousedown","mousemove","keypress","scroll","touchstart","click"].forEach(t=>{document.addEventListener(t,()=>{this.updateLastActivity()},{passive:!0})})}updateLastActivity(){let e=this.authStateSubject.value;if(e.isAuthenticated&&e.user){let t=o(n({},e.user),{lastActivity:new Date}),s=o(n({},e),{user:t});this.authStateSubject.next(s),this.saveSessionToStorage(s)}}startSessionTimer(e){this.sessionTimer$=p(e),this.sessionTimer$.pipe(g(this.sessionEndSubject)).subscribe(()=>{this.handleSessionExpiry()})}handleSessionExpiry(){this.clearSession(),this.router.navigate(["/auth/login"],{queryParams:{message:"session-expired"}})}saveSessionToStorage(e){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(t){console.error("Error saving session to storage:",t)}}clearSession(){localStorage.removeItem(this.STORAGE_KEY),this.authStateSubject.next({isAuthenticated:!1,user:null}),this.sessionEndSubject.next(!0)}register(e){return new l(t=>{if(this.users.some(i=>i.username===e.username)){t.next(!1),t.complete();return}let s=o(n({},e),{role:"user"});this.users.push(s);let r=this.users.filter(i=>i.username!=="admin"&&i.username!=="user");localStorage.setItem(this.USERS_KEY,JSON.stringify(r)),t.next(!0),t.complete()})}login(e,t){return new l(s=>{let r=this.users.find(i=>i.username===e&&i.password===t);if(r){let i=new Date,u=new Date(i.getTime()+this.SESSION_TIMEOUT),a={isAuthenticated:!0,user:o(n({},r),{loginTime:i,lastActivity:i}),sessionExpiry:u};this.authStateSubject.next(a),this.saveSessionToStorage(a),this.startSessionTimer(this.SESSION_TIMEOUT),s.next(!0)}else s.next(!1);s.complete()})}logout(){return new l(e=>{this.clearSession(),this.router.navigate(["/auth/login"]),e.next(!0),e.complete()})}isLoggedIn(){return this.authStateSubject.value.isAuthenticated}getCurrentUser(){return this.authStateSubject.value.user}getUserRole(){return this.authStateSubject.value.user?.role||null}hasRole(e){return this.getUserRole()===e}getSessionTimeRemaining(){return this.authState$.pipe(h(e=>{if(!e.sessionExpiry)return 0;let t=e.sessionExpiry.getTime()-new Date().getTime();return Math.max(0,t)}))}refreshSession(){return new l(e=>{let t=this.authStateSubject.value;if(t.isAuthenticated&&t.user){let s=new Date,r=new Date(s.getTime()+this.SESSION_TIMEOUT),i=o(n({},t),{sessionExpiry:r,user:o(n({},t.user),{lastActivity:s})});this.authStateSubject.next(i),this.saveSessionToStorage(i),this.sessionEndSubject.next(!0),this.startSessionTimer(this.SESSION_TIMEOUT),e.next(!0)}else e.next(!1);e.complete()})}updateUserProfile(e){return new l(t=>{let s=this.authStateSubject.value;if(!s.isAuthenticated||!s.user){t.next(!1),t.complete();return}let r=this.users.findIndex(a=>a.username===s.user.username);if(r===-1){t.next(!1),t.complete();return}let i=o(n(n({},this.users[r]),e),{updatedAt:new Date,username:this.users[r].username,password:this.users[r].password,role:this.users[r].role});this.users[r]=i;let u=o(n({},s),{user:i});this.authStateSubject.next(u),this.saveSessionToStorage(u);let c=this.users.filter(a=>a.username!=="admin"&&a.username!=="user");localStorage.setItem(this.USERS_KEY,JSON.stringify(c)),t.next(!0),t.complete()})}changePassword(e,t){return new l(s=>{let r=this.authStateSubject.value;if(!r.isAuthenticated||!r.user){s.next(!1),s.complete();return}let i=this.users.findIndex(a=>a.username===r.user.username&&a.password===e);if(i===-1){s.next(!1),s.complete();return}this.users[i]=o(n({},this.users[i]),{password:t,updatedAt:new Date});let u=o(n({},r),{user:this.users[i]});this.authStateSubject.next(u),this.saveSessionToStorage(u);let c=this.users.filter(a=>a.username!=="admin"&&a.username!=="user");localStorage.setItem(this.USERS_KEY,JSON.stringify(c)),s.next(!0),s.complete()})}static \u0275fac=function(t){return new(t||S)(E(v))};static \u0275prov=f({token:S,factory:S.\u0275fac,providedIn:"root"})};export{b as a};
